---
# Playbook principal pour déployer Unmute
- name: "Deploy Unmute Application on AWS"
  hosts: aws_gpu_instances
  become: yes
  gather_facts: yes
  
  vars_prompt:
    - name: "confirm_deployment"
      prompt: "Êtes-vous sûr de vouloir déployer Unmute en production? (yes/no)"
      private: no
      default: "no"

  pre_tasks:
    - name: "Vérifier la confirmation de déploiement"
      fail:
        msg: "Déploiement annulé par l'utilisateur"
      when: confirm_deployment != "yes"
    
    - name: "Afficher les informations de l'instance"
      debug:
        msg:
          - "Instance: {{ inventory_hostname }}"
          - "IP: {{ ansible_default_ipv4.address }}"
          - "Mémoire totale: {{ ansible_memory_mb.real.total }}MB"
          - "CPU cores: {{ ansible_processor_cores }}"

  roles:
    - role: common
      tags: ["common", "base"]

    - role: docker
      tags: ["docker"]

    - role: nvidia
      tags: ["nvidia", "gpu"]

    - role: unmute
      tags: ["unmute", "app"]

  post_tasks:
    - name: "Vérifier que tous les services sont démarrés"
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:{{ unmute_backend_port }}/health"
        method: GET
        timeout: 30
      register: health_check
      retries: 10
      delay: 15
      until: health_check.status == 200
      tags: ["health"]

    - name: "Afficher les URLs d'accès"
      debug:
        msg:
          - "✅ Déploiement terminé avec succès!"
          - "🌐 Frontend: http://{{ ansible_default_ipv4.address }}:{{ unmute_frontend_port }}"
          - "🔧 Backend: http://{{ ansible_default_ipv4.address }}:{{ unmute_backend_port }}"
          - "📊 Grafana: http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}"
          - "📈 Prometheus: http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}"
          - "🖥️ SSH: ssh -i {{ ansible_ssh_private_key_file }} {{ ansible_user }}@{{ ansible_default_ipv4.address }}"
      tags: ["info"]
